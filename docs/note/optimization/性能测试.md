# 性能测试

## 性能测试的目的
发现性能瓶颈

## 性能测试的分类
性能测试是一个非常广泛的概念，包括的很多方面的测试，也可称之为非功能测试。

自动化测试属于功能测试的范围，由于其测试方法要求测试人员拥有一定的代码能力，所以被单独分成一个测试模块。

### 具体分类
- 负载测试:通过逐步加压的方法，达到既定的性能阀值的目标，阀值的设定应是小于等于某个值，如cpu使用率小于等于80%。

- 压力测试:通过逐步加压的方法，使得系统的某些资源达到饱和，甚至失效的状态，简单粗暴的解释就是什么条件能把系统压崩溃。

- 并发测试:在同一时间内，多个虚拟用户同时访问同一模块，同一功能，通常的测试方法是设置集合点。

- 容量测试:通常是指数据库层面的，目标是获取数据库的最佳容量的能力。又称之为容量预估。具体测试方法为在一定的并发用户，不同的基础数据量下，观察数据库的处理能力，即获取数据库的各项性能指标。

- 可靠性测试:又称之为稳定性测试或疲劳测试。是指系统在高压情况下，长时间的运行系统是否稳定。如cpu使用率在80%以上，7*24小时运行，系统是否稳定。

- 异常测试:又称之为失败测试。是指系统架构方面的测试。如在负载均衡架构中，要测试宕机，节点挂掉等情况系统的反应。

## 性能测试的工作流程

![](/optimization/20191023161351462.png)

- 需求分析:主要属性项目主要做的什么，哪些是重点，哪些是主要业务流程
- 性能指标(阶段性指标亦需考虑):关于吞吐量，tps，定义并发数等(满足业务需求)
- 脚本开发:纯代码，工具辅助
- 场景设置:调试脚本，设置场景(与需求分析有关联，需要符合用户在系统上的使用流程，经常做的操作为性能测试重点)
- 监控部署:对服务器，本地单独进行监控部署(因为工具收集的结果不全)
- 测试执行:基础测试(先少量用户并发先跑)能发现多并发下应用程序对多线程逻辑问题，多并发测试(大批用户并发跑)
- 性能分析:监控足够完善，分析才能全面，有理有据
- 性能调优
- 测试报告:满足前面所有指标才能写

## 常见系统应用分层架构

![](/optimization/20191023170453194.png)

- 显示层:web,android,ios,H5
- 逻辑控制层:Api(监控Api)
- 数据存储层:mysql(监控mysql)，mongodb，redis
- 监控linux服务器本身的运行状态(有时候服务器配置低，本身扛不住；外部层面图片视频内容加载(比如先加载视频js后加载图片，可能感觉到页面卡顿；所以应该先加载图片，因为视频js是控制某些业务逻辑的))
- 分块分拆测试，一块一块测试
- 数据库测试:把研发代码拿过来，把里面跟数据库产生交互的sql语句抽离出来，然后开发成性能测试脚本，对mysql数据库进行性能测试，好处是没有其它因素干扰，如果发现问题，肯定是mysql本身的问题，要么进行sql语句调优、要么进行mysql配置调优、要么进行服务器层面的硬件调优


## 性能测试指标定义
- 事务:从客户端发起的一个或多个请求(这些请求组成一个完整的操作),到客户端接收到从服务器返回的响应
- TPS(Transaction Per Second):每秒钟系统能够处理的事务数
- 请求响应时间:从客户端发起的一个请求开始，到客户端接收到从服务器返回的响应。整个过程所耗费的时间
- 事务响应时间:事务可能是由一个或多个请求组成的，事务响应时间主要是针对于用户角度而言，如转账
- 并发定义:没有严格意义上的并发。并发总有先后，无论差距是1毫秒或者1微妙，总有一个时间差，所以并发讲的是一个时间范围内，比如1秒内。所以一般说1秒内发起多少个并发
    
    并发举例
    - 多用户在系统上进行同一操作： 比如双十一，大家针对同一商品进行秒杀。--- 同一系统上同一功能操作
    - 多用户在系统上进行不同操作，比如双十一，大家针对不同商品进行秒杀，或者是大家有进行其他不同的操作，比如商品浏览。--- 同一系统上不同功能操作
- 并发用户数:同一单位时间内对系统发起请求的用户数量
- 吞吐量:一次性能测试过程中网络上传输的数据量的总和
- 吞吐率:单位时间内网络上传输的数据流。吞吐率 = 吞吐量 / 传输时间
- 点击率:每秒钟用户向服务器提交的请求数。这是Web应用程序特有的一个指标，可以想象为每秒钟用户总共在页面上进行多少次点击操作，但是需要注意的是一次鼠标单击的操作后，客户端有可能向服务器发送了多次请求
- 资源使用率：对不同的系统资源的使用情况，如cpu，内存，io

## 性能测试的需求分析

### 分析的目的
- 明确测试指标
- 明确测试场景

### 新系统
- 同行业比较
- 业务预期

### 老系统
- 对比以往的用户使用行为以及用户量

## 性能测试工具
常用工具:
- LoadRunner
- JMeter

**对比**

| 对比纬度 | LoadRunner | JMeter |
| -- | -- | -- |
| 量级 | 重 | 轻 |
| 易用性 | 易 | 易 |
| 是否开源 | 否 | 是 |
| 语言支持 | C/java1.5 | java |
| 是否收费 | 是 | 否 |


## JMeter

### JMeter安装

首先去https://jmeter.apache.org/download_jmeter.cgi网站下载安装包

![](/optimization/1608468203808.jpg)

然后需要配置java环境，这里不多写了

cd到apache-jmeter/bin目录下，mac运行jmeter.sh，window运行jmeter.bat

![](/optimization/1608385080392.jpg)

### Jmeter实现多并发
- 线程组:负载发生器，用多线程或多进程的方式来模拟用户的使用行为。JMeter是以线程的方式来进行模拟用户的并发访问的。

### Jmeter实现逻辑分之控制
- 逻辑控制器:用来控制测试脚本的逻辑判断，也可以理解为如何控制脚本的运行。例如:如果控制器，就是当满足什么样的条件后执行哪一步操作。

### Jmeter实现配置管理
- 配置元件:用来提供一些配置相关的信息，如Http请求头，cookie管理，提供参数化数据。还可以进行用户自定义变量等配，用以来定义常量等。

### Jmeter实现请求预处理
- 前置处理器:用于在实际的请求发出之前对即将发出的请求进行特殊处理。例如，用户参数，可以在实际发送请求之前来定义变量，可以在后边的实际请求中进行使用。

### Jmeter集合点，定时并发
- 定时器:用于操作与操作之间设置等待时间，等待时间是性能测试中常用的控制客户端QPS的手段。类似LoadRunner里面的"思考时间"。

### Jmeter实现各种请求的发送
- Sampler:取样器，是性能测试中向服务器发送请求，记录响应信息，记录响应事件的最小单元，JMeter原生支持多种不同的Sampler。

### Jmeter实现关联
- 后置处理器:(关联概念的应用器)用于对Sampler发出请求后得到的服务器响应进行处理。一般用来提取响应中的特定数据。

### Jmeter实现数据预判
- 断言:断言用于检查测试中得到的相应数据是否符合预期，断言一般用来设置检查点，用以保证性能测试过程中的数据交互是否预期一致。


### 函数助手
- 随机数(_Random)
- 参数化助手(_CSVRead)
- 计数器(_counter)
- 唯一数(_UUID)

![](/optimization/1608472240749.jpg)


### Jmeter实现分布式并发
- Master在jmeter.properties中添加remote_hosts
- Slave在jmeter.properties中添加server_port
- Slave启动jmeter-server


## 服务器性能测试范围

测试目的:发现服务器的性能瓶颈。配置的不同能够承载的最大任务数不同，能够承载的压力也不同

测试范围及性能指标
- CPU
- 内存
- 网络
- 版本
- 磁盘

测试与生产的环境配置不同？
- 通过多次压测来计算性能损耗

性能损耗的计算方式
- 多次压测后的性能预估

![](/optimization/1608473819458.jpg)







