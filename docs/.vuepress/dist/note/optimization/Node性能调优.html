<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node性能调优 | 码农机器人</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="努力向前">
    <link rel="preload" href="/assets/css/0.styles.36f06804.css" as="style"><link rel="preload" href="/assets/js/app.f038ea5d.js" as="script"><link rel="preload" href="/assets/js/2.8fa949b0.js" as="script"><link rel="preload" href="/assets/js/63.1d9f7fbe.js" as="script"><link rel="prefetch" href="/assets/js/10.ed293fac.js"><link rel="prefetch" href="/assets/js/100.3f0f293d.js"><link rel="prefetch" href="/assets/js/101.4e99c0f1.js"><link rel="prefetch" href="/assets/js/102.26efe53a.js"><link rel="prefetch" href="/assets/js/103.ba99145c.js"><link rel="prefetch" href="/assets/js/104.db586700.js"><link rel="prefetch" href="/assets/js/105.3f4cb5ee.js"><link rel="prefetch" href="/assets/js/106.b0e018bc.js"><link rel="prefetch" href="/assets/js/107.2f0d0016.js"><link rel="prefetch" href="/assets/js/108.80cef010.js"><link rel="prefetch" href="/assets/js/11.072d810f.js"><link rel="prefetch" href="/assets/js/12.bb621195.js"><link rel="prefetch" href="/assets/js/13.1818e600.js"><link rel="prefetch" href="/assets/js/14.ad627559.js"><link rel="prefetch" href="/assets/js/15.0a7ad009.js"><link rel="prefetch" href="/assets/js/16.4cc7a0a8.js"><link rel="prefetch" href="/assets/js/17.cf7b05ba.js"><link rel="prefetch" href="/assets/js/18.162e03d1.js"><link rel="prefetch" href="/assets/js/19.197a410b.js"><link rel="prefetch" href="/assets/js/20.2fc66560.js"><link rel="prefetch" href="/assets/js/21.30b35824.js"><link rel="prefetch" href="/assets/js/22.5f135ac3.js"><link rel="prefetch" href="/assets/js/23.04883853.js"><link rel="prefetch" href="/assets/js/24.9d666797.js"><link rel="prefetch" href="/assets/js/25.0f45dd0a.js"><link rel="prefetch" href="/assets/js/26.638591ac.js"><link rel="prefetch" href="/assets/js/27.d6bf108a.js"><link rel="prefetch" href="/assets/js/28.dfa65bc1.js"><link rel="prefetch" href="/assets/js/29.14fb341e.js"><link rel="prefetch" href="/assets/js/3.df845a0f.js"><link rel="prefetch" href="/assets/js/30.7a5938e2.js"><link rel="prefetch" href="/assets/js/31.6a17cb7d.js"><link rel="prefetch" href="/assets/js/32.d2827efc.js"><link rel="prefetch" href="/assets/js/33.ae75a8d9.js"><link rel="prefetch" href="/assets/js/34.296f2e30.js"><link rel="prefetch" href="/assets/js/35.b2064323.js"><link rel="prefetch" href="/assets/js/36.0046bb67.js"><link rel="prefetch" href="/assets/js/37.ba891918.js"><link rel="prefetch" href="/assets/js/38.d3431c21.js"><link rel="prefetch" href="/assets/js/39.68613e20.js"><link rel="prefetch" href="/assets/js/4.6f69a0ec.js"><link rel="prefetch" href="/assets/js/40.3c24b563.js"><link rel="prefetch" href="/assets/js/41.d5cf0e80.js"><link rel="prefetch" href="/assets/js/42.d382045e.js"><link rel="prefetch" href="/assets/js/43.078e68a2.js"><link rel="prefetch" href="/assets/js/44.bec9a684.js"><link rel="prefetch" href="/assets/js/45.6b28db99.js"><link rel="prefetch" href="/assets/js/46.d587148c.js"><link rel="prefetch" href="/assets/js/47.6c1b1f0d.js"><link rel="prefetch" href="/assets/js/48.21b1f996.js"><link rel="prefetch" href="/assets/js/49.f0a679bf.js"><link rel="prefetch" href="/assets/js/5.29fae726.js"><link rel="prefetch" href="/assets/js/50.8635f872.js"><link rel="prefetch" href="/assets/js/51.dd140f01.js"><link rel="prefetch" href="/assets/js/52.26f631aa.js"><link rel="prefetch" href="/assets/js/53.f3add058.js"><link rel="prefetch" href="/assets/js/54.f756d00a.js"><link rel="prefetch" href="/assets/js/55.b3ba5b3e.js"><link rel="prefetch" href="/assets/js/56.4dcf8e63.js"><link rel="prefetch" href="/assets/js/57.aa245b79.js"><link rel="prefetch" href="/assets/js/58.a1b1881b.js"><link rel="prefetch" href="/assets/js/59.275a7cfd.js"><link rel="prefetch" href="/assets/js/6.6a9558d6.js"><link rel="prefetch" href="/assets/js/60.9fac0369.js"><link rel="prefetch" href="/assets/js/61.3c62b320.js"><link rel="prefetch" href="/assets/js/62.b5c6a6c5.js"><link rel="prefetch" href="/assets/js/64.bfe46483.js"><link rel="prefetch" href="/assets/js/65.421abc3b.js"><link rel="prefetch" href="/assets/js/66.127d41bf.js"><link rel="prefetch" href="/assets/js/67.33253334.js"><link rel="prefetch" href="/assets/js/68.802bfa0c.js"><link rel="prefetch" href="/assets/js/69.b90039c7.js"><link rel="prefetch" href="/assets/js/7.20ebb3ce.js"><link rel="prefetch" href="/assets/js/70.a546d08b.js"><link rel="prefetch" href="/assets/js/71.7e300fb8.js"><link rel="prefetch" href="/assets/js/72.d7283940.js"><link rel="prefetch" href="/assets/js/73.8fbfcd15.js"><link rel="prefetch" href="/assets/js/74.3cdd326d.js"><link rel="prefetch" href="/assets/js/75.9b4a55f9.js"><link rel="prefetch" href="/assets/js/76.7367e408.js"><link rel="prefetch" href="/assets/js/77.a5ea1e1d.js"><link rel="prefetch" href="/assets/js/78.62c0c83d.js"><link rel="prefetch" href="/assets/js/79.20ae6b33.js"><link rel="prefetch" href="/assets/js/8.34110c5a.js"><link rel="prefetch" href="/assets/js/80.591b6495.js"><link rel="prefetch" href="/assets/js/81.fb929ad1.js"><link rel="prefetch" href="/assets/js/82.560b381f.js"><link rel="prefetch" href="/assets/js/83.eb4f5181.js"><link rel="prefetch" href="/assets/js/84.2a927c54.js"><link rel="prefetch" href="/assets/js/85.0685cc81.js"><link rel="prefetch" href="/assets/js/86.02826a44.js"><link rel="prefetch" href="/assets/js/87.4104360f.js"><link rel="prefetch" href="/assets/js/88.87f924ce.js"><link rel="prefetch" href="/assets/js/89.e907841e.js"><link rel="prefetch" href="/assets/js/9.9450eba1.js"><link rel="prefetch" href="/assets/js/90.ed7713b5.js"><link rel="prefetch" href="/assets/js/91.11be5c5f.js"><link rel="prefetch" href="/assets/js/92.03ca73f8.js"><link rel="prefetch" href="/assets/js/93.4d5cfeea.js"><link rel="prefetch" href="/assets/js/94.a5240ffa.js"><link rel="prefetch" href="/assets/js/95.40e59a02.js"><link rel="prefetch" href="/assets/js/96.671ee618.js"><link rel="prefetch" href="/assets/js/97.0612f27a.js"><link rel="prefetch" href="/assets/js/98.de33209e.js"><link rel="prefetch" href="/assets/js/99.b686994e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.36f06804.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="码农机器人" class="logo"> <span class="site-name can-hide">码农机器人</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  react
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  react
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>建立前端知识体系</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>提效赋能 前端工程化篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>全栈赋能 Node篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>程序员PLUS篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>性能优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/optimization/性能优化初探.html" class="sidebar-link">性能优化初探</a></li><li><a href="/note/optimization/测试网速.html" class="sidebar-link">测试网速</a></li><li><a href="/note/optimization/资源加载顺序.html" class="sidebar-link">资源加载顺序</a></li><li><a href="/note/optimization/浏览器渲染流程.html" class="sidebar-link">浏览器渲染流程</a></li><li><a href="/note/optimization/各项指标的意义.html" class="sidebar-link">各项指标的意义</a></li><li><a href="/note/optimization/Chrome性能分析.html" class="sidebar-link">Chrome性能分析</a></li><li><a href="/note/optimization/资源优化.html" class="sidebar-link">资源优化</a></li><li><a href="/note/optimization/传输加载优化.html" class="sidebar-link">传输加载优化</a></li><li><a href="/note/optimization/用RAIL模型分析性能.html" class="sidebar-link">用RAIL模型分析性能</a></li><li><a href="/note/optimization/performance面板解决性能.html" class="sidebar-link">performance面板解决性能</a></li><li><a href="/note/optimization/Node性能调优.html" class="active sidebar-link">Node性能调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#内存泄漏" class="sidebar-link">内存泄漏</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#压力测试-寻找内存泄漏" class="sidebar-link">压力测试 寻找内存泄漏</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#什么是qps" class="sidebar-link">什么是QPS</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#wrk进行压测" class="sidebar-link">wrk进行压测</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#使用memeye查看内存" class="sidebar-link">使用Memeye查看内存</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#process-memoryusage" class="sidebar-link">process.memoryUsage</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#内存泄漏原因以及编码规范" class="sidebar-link">内存泄漏原因以及编码规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#内存膨胀" class="sidebar-link">内存膨胀</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#队列消息不及时" class="sidebar-link">队列消息不及时</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#编码不规范" class="sidebar-link">编码不规范</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#buffer" class="sidebar-link">Buffer</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#调试工具-clinicjs" class="sidebar-link">调试工具 clinicjs</a></li><li class="sidebar-sub-header"><a href="/note/optimization/Node性能调优.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>忍者秘籍书</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node性能调优"><a href="#node性能调优" class="header-anchor">#</a> Node性能调优</h1> <h2 id="内存泄漏"><a href="#内存泄漏" class="header-anchor">#</a> 内存泄漏</h2> <p>程序运行需要内存。对于连续运行得服务进程，必须及时释放不在用到的内存，否则，内存占用会越来越高，轻则影响系统性能，重则导致进程崩溃。不在用到的内存，没有及时释放，叫做内存泄漏。</p> <p><strong>具体表现</strong></p> <p><img src="/node/neicun.png" alt=""></p> <ul><li>随着内存泄漏得增长, <strong>V8</strong> 对垃圾收集器越来越具有攻击性，这会使你得应用运行速度变慢</li> <li>内存泄漏可能触发其他类型的失败，内存泄漏得代码可能会持续引用有限得资源，可能会耗尽文件描述符，还可能突然不能建立链接新的数据库链接</li> <li>应用迟早会崩溃</li></ul> <p>点击 <strong>Memory</strong> 手机内存快照</p> <h2 id="压力测试-寻找内存泄漏"><a href="#压力测试-寻找内存泄漏" class="header-anchor">#</a> 压力测试 寻找内存泄漏</h2> <h3 id="什么是qps"><a href="#什么是qps" class="header-anchor">#</a> 什么是QPS</h3> <p><strong>PV</strong> :网站当日访问人数 <strong>UV</strong> :独立访问人数，换算公式:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">QPS</span> <span class="token operator">=</span> <span class="token constant">PV</span><span class="token operator">/</span>t
</code></pre></div><p>如:1000000/(10<em>60</em>60) = 27.7(100万个请求集中在10个小时，服务器每秒需要处理27.7个业务请求)</p> <h3 id="wrk进行压测"><a href="#wrk进行压测" class="header-anchor">#</a> wrk进行压测</h3> <p><strong>wrk</strong> 是一个用来做HTTP benchmark测试的工具</p> <p>安装wrk</p> <div class="language-js extra-class"><pre class="language-js"><code>brew install wrk
</code></pre></div><p>命令行敲下wrk，查看帮助</p> <div class="language- extra-class"><pre><code>使用方法: wrk &lt;选项&gt; &lt;被测HTTP服务的URL&gt;                            
Options:                                            
-c, --connections &lt;N&gt;  跟服务器建立并保持的TCP连接数量  
-d, --duration    &lt;T&gt;  压测时间           
-t, --threads     &lt;N&gt;  使用多少个线程进行压测   
                                                  
-s, --script      &lt;S&gt;  指定Lua脚本路径       
-H, --header      &lt;H&gt;  为每一个HTTP请求添加HTTP头      
    --latency          在压测结束后，打印延迟统计信息   
    --timeout     &lt;T&gt;  超时时间     
-v, --version          打印正在使用的wrk的详细版本信息
                                                  
&lt;N&gt;代表数字参数，支持国际单位 (1k, 1M, 1G)
&lt;T&gt;代表时间参数，支持时间单位 (2s, 2m, 2h)
</code></pre></div><p>做一次简单压测</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wrk -t12 -c200 -d 60s http://127.0.0.1:3000&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>启动命令</p> <div class="language-js extra-class"><pre class="language-js"><code>node index<span class="token punctuation">.</span>js
node run test
</code></pre></div><p>压测结果如下:
<img src="/node/work.png" alt=""></p> <table><thead><tr><th>属性</th> <th style="text-align:center;">名称</th> <th style="text-align:right;">含义</th></tr></thead> <tbody><tr><td>Avg</td> <td style="text-align:center;">平均值</td> <td style="text-align:right;">每次测试的平均值</td></tr> <tr><td>Stdev</td> <td style="text-align:center;">标准偏差</td> <td style="text-align:right;">结果果的离散程度,越高说明越不稳定</td></tr> <tr><td>Max</td> <td style="text-align:center;">最大值</td> <td style="text-align:right;">最大一次结果</td></tr> <tr><td>+/- SStdev</td> <td style="text-align:center;">正负一个标准差占比</td> <td style="text-align:right;">结果的离散程度，越大越不稳定</td></tr></tbody></table> <p>Latency:可以理解未响应时间</p> <p>Req/Sec:每个线程每秒钟的完成请求数，一般来说我们主要关注平均值和最大值。标准差如果太大说明样本本身离散程度比较高，有可能系统性能波动很大</p> <h3 id="使用memeye查看内存"><a href="#使用memeye查看内存" class="header-anchor">#</a> 使用Memeye查看内存</h3> <p>Memeye是一个轻量级得NodeJS进程监控工具，它提供进程内存，V8堆空间内存，操作系统内存 三大纬度得数据可视化展示</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install memeye <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><p>用法也很简单</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> memeye <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'memeye'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memeye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> leakArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        leakArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>leakArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>再次启动Node服务，会给我们在本地在起另一个服务http://localhost:23333,如下</p> <p><img src="/node/memeye.png" alt=""></p> <h3 id="process-memoryusage"><a href="#process-memoryusage" class="header-anchor">#</a> process.memoryUsage</h3> <p>使用 <strong>process.memoryUsage</strong> 可以查看内存使用情况，如下:</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

key <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>终端会显示 内存占用情况</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  rss<span class="token operator">:</span> <span class="token number">18481152</span><span class="token punctuation">,</span>
  heapTotal<span class="token operator">:</span> <span class="token number">4014080</span><span class="token punctuation">,</span>
  heapUsed<span class="token operator">:</span> <span class="token number">2237704</span><span class="token punctuation">,</span>
  external<span class="token operator">:</span> <span class="token number">764981</span><span class="token punctuation">,</span>
  arrayBuffers<span class="token operator">:</span> <span class="token number">9382</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  rss<span class="token operator">:</span> <span class="token number">61792256</span><span class="token punctuation">,</span>
  heapTotal<span class="token operator">:</span> <span class="token number">46886912</span><span class="token punctuation">,</span>
  heapUsed<span class="token operator">:</span> <span class="token number">44959104</span><span class="token punctuation">,</span>
  external<span class="token operator">:</span> <span class="token number">933057</span><span class="token punctuation">,</span>
  arrayBuffers<span class="token operator">:</span> <span class="token number">9382</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="内存泄漏原因以及编码规范"><a href="#内存泄漏原因以及编码规范" class="header-anchor">#</a> 内存泄漏原因以及编码规范</h2> <h3 id="内存膨胀"><a href="#内存膨胀" class="header-anchor">#</a> 内存膨胀</h3> <p>如下我们对某个接口进行统计</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'statr'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> leakArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    leakArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'leak'</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello word'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这时内存会不断膨胀，因为函数内得变量是可以随着函数执行被回收得，但是全局不行。如果实在业务需求应避免使用对象作为缓存，可移不到Redis等</p> <h3 id="队列消息不及时"><a href="#队列消息不及时" class="header-anchor">#</a> 队列消息不及时</h3> <p>例如 收集日志:</p> <p>如果日志产生速度大于文件写入速度，就容易产生内存泄漏(压测工具以及收到返回，服务器log4日志还在不停写入)。表层解决办法可以更换消费速度更快得技术，但这不治本。</p> <p><strong>根本解决</strong> 办法应该是监控队列长度，一旦堆积就报警或者拒绝新得请求，还有一种是所有的一步调用都有超时，一旦达到时间调用没得到结果就报警</p> <h3 id="编码不规范"><a href="#编码不规范" class="header-anchor">#</a> 编码不规范</h3> <p><strong>闭包</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> tem_obj <span class="token operator">=</span> <span class="token punctuation">{</span>
        x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        y<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        arr<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 目前闭包只引用了clone</span>
    <span class="token keyword">let</span> clone <span class="token operator">=</span> tem_obj<span class="token punctuation">.</span>x
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> clone
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上 我们只需要用x，那么只需要引用 <strong>tem_obj.x</strong> 即可，而不是返回整个 <strong>tem_obj</strong></p> <p>闭包不可怕，可怕的是闭包里面引用了大对象</p> <p><strong>GC 无法回收</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre></div><p>正确的是我们需要 先 移除 map 对 key 的引用,再把 key 设置 null</p> <div class="language-js extra-class"><pre class="language-js"><code>map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
key <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre></div><p><strong>频繁的垃圾回收让GC没有机会工作</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// function strToArray(str) {</span>
<span class="token comment">//     let i = 0;</span>
<span class="token comment">//     const len = str.length;</span>
<span class="token comment">//     let arr = Array(len);</span>
<span class="token comment">//     for (; i &lt; len; i++) {</span>
<span class="token comment">//         arr[i] = str.charCodeAt(i) + Math.random();</span>
<span class="token comment">//     }</span>
<span class="token comment">//     return arr;</span>
<span class="token comment">// }</span>
<span class="token comment">// function foo() {</span>
<span class="token comment">//     let i = 0;</span>
<span class="token comment">//     let str = 'test v8 GC';</span>
<span class="token comment">//     while (i++ &lt; 10000) {</span>
<span class="token comment">//         strToArray(str);</span>
<span class="token comment">//     }</span>
<span class="token comment">// }</span>
<span class="token comment">// foo();</span>

<span class="token keyword">function</span> <span class="token function">strToArray</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> bufferView</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bufferView<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bufferView<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'test v8 GC'</span><span class="token punctuation">;</span>
    <span class="token comment">// SharedArrayBuffer = 连续的内存</span>
    <span class="token keyword">let</span> bufferView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">strToArray</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> bufferView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span><span class="token number">8135</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">43</span> ms: Scavenge <span class="token number">2.3</span> <span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">1.9</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.8</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure 
<span class="token punctuation">[</span><span class="token number">8135</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">54</span> ms: Scavenge <span class="token number">2.4</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.0</span> <span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.7</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure 
<span class="token punctuation">[</span><span class="token number">8135</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">55</span> ms: Scavenge <span class="token number">3.0</span> <span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.0</span> <span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.2</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure 
<span class="token punctuation">[</span><span class="token number">8135</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">57</span> ms: Scavenge <span class="token number">4.0</span> <span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.0</span> <span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.1</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure
<span class="token comment"># 优化后</span>
node --trace-gc demo4.js 
<span class="token punctuation">[</span><span class="token number">8139</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">36</span> ms: Scavenge <span class="token number">2.3</span> <span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">1.9</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.8</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure 
<span class="token punctuation">[</span><span class="token number">8139</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">46</span> ms: Scavenge <span class="token number">2.4</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.0</span> <span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.8</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure 
<span class="token punctuation">[</span><span class="token number">8139</span>:0x1045e7000<span class="token punctuation">]</span>       <span class="token number">47</span> ms: Scavenge <span class="token number">3.0</span> <span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.0</span> <span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">)</span> MB, <span class="token number">0.2</span> / <span class="token number">0.0</span> ms  <span class="token punctuation">(</span>average mu <span class="token operator">=</span> <span class="token number">1.000</span>, current mu <span class="token operator">=</span> <span class="token number">1.000</span><span class="token punctuation">)</span> allocation failure
</code></pre></div><h2 id="buffer"><a href="#buffer" class="header-anchor">#</a> Buffer</h2> <h2 id="调试工具-clinicjs"><a href="#调试工具-clinicjs" class="header-anchor">#</a> 调试工具 clinicjs</h2> <p><a href="https://clinicjs.org/" target="_blank" rel="noopener noreferrer">clinicjs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://youjingyu.github.io/clinic-doc-zh/" target="_blank" rel="noopener noreferrer">中文文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>准确计算 QPS 未雨绸缪</li> <li>利用压测工具发现内存是否有异常</li> <li>缓存 队列内存泄漏 耗时较长的任务</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">8/25/2021, 3:56:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/optimization/performance面板解决性能.html" class="prev">
        performance面板解决性能
      </a></span> <span class="next"><a href="/note/flutter/搭建Flutter开发环境.html">
        搭建 Flutter 开发环境
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.f038ea5d.js" defer></script><script src="/assets/js/2.8fa949b0.js" defer></script><script src="/assets/js/63.1d9f7fbe.js" defer></script>
  </body>
</html>
