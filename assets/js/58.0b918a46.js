(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{469:function(t,s,a){"use strict";a.r(s);var r=a(33),e=Object(r.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab自动化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab自动化"}},[t._v("#")]),t._v(" gitlab自动化")]),t._v(" "),a("h2",{attrs:{id:"gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab"}},[t._v("#")]),t._v(" Gitlab")]),t._v(" "),a("p",[t._v("Gitlab是一个开源的版本管理系统，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。它拥有与Github类似的功能，能够浏览源码，管理缺陷和注释，可以管理团队对仓库的访问，它非常易于浏览提交的版本并提供一个文件历史库。团队成员可以利用内置的简单的聊天程序进行交流。它还提供一个代码片段收集功能可以实现代码复用。")]),t._v(" "),a("p",[t._v("GitLab对于系统性能有要求，所以我们需要将克隆出来的虚拟机的内存提高到至少2G以上。")]),t._v(" "),a("h3",{attrs:{id:"gitlab安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab安装"}},[t._v("#")]),t._v(" Gitlab安装")]),t._v(" "),a("p",[t._v("方法一:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("sudo docker run "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("detach \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("hostname localhost \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("publish "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("publish "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("publish "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("222")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name gitlab \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("restart always \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("volume "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("volume "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("volume "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab \\\n  gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n")])])]),a("p",[t._v("localhost:主机名,即虚拟机的ip,8084可以自己定义端口号,restart重启方式,volume目录挂载,gitlab/gitlab-ce:latest镜像名。")]),t._v(" "),a("p",[t._v("方法二:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("docker pull twang2218"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zh\n")])])]),a("p",[t._v("等待其拉取，然后在 /home下新建docker目录，再在其下新建gitlab目录，进入gitlab目录，在当前目录下新建docker-compose.yml配置文件，编写内容如下。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("version"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\nservices"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n   web"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n     image"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'twang2218/gitlab-ce-zh'")]),t._v("   #gitlab镜像\n     restart"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" always\n     privileged"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("  #权限\n     hostname"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("       #主机名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("即虚拟机的ip\n     environment"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TZ")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Asia/Shanghai'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GITLAB_OMNIBUS_CONFIG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n            external_url "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v(" #主机名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("即虚拟机的ip\n            gitlab_rails"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab_shell_ssh_port'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2222")]),t._v("\n            unicorn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'port'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8888")]),t._v("\n            nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listen_port'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),t._v("\n     ports"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8084:8084'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8443:443'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2222:22'")]),t._v("\n     volumes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./config:/etc/gitlab'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./logs:/var/log/gitlab'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./data:/var/opt/gitlab'")]),t._v("\n")])])]),a("p",[t._v("执行"),a("code",[t._v("docker-compose up")]),t._v("，然后进入等待时间，等它下好了去通过自己设置的虚拟机的ip和端口号访问。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622287438766a.jpg",alt:""}})]),t._v(" "),a("p",[t._v("如果安装过程中有报错权限问题，那么加上"),a("code",[t._v("privileged: true")])]),t._v(" "),a("p",[t._v("查看方式:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("root@iZm5ebvlfc3n55vzckl9ifZ"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("# docker ps\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CONTAINER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ID")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IMAGE")]),t._v("                         "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COMMAND")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CREATED")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("STATUS")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PORTS")]),t._v("                                                                         "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NAMES")]),t._v("\nddc7d0e214ef        twang2218"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zh        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/assets/wrapper"')]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" hours ago        Up "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hours")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2222")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp   gitlab_web_1\n\n")])])]),a("p",[t._v("通过虚拟主机的ip+端口访问，此时需要设置管理员密码，账号为root，密码最少为8位。")]),t._v(" "),a("p",[t._v("登录成功后，如下:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622288085865b.jpg",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"项目创建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目创建"}},[t._v("#")]),t._v(" 项目创建")]),t._v(" "),a("p",[t._v("点击 "),a("code",[t._v("+")]),t._v(" 号 --\x3e "),a("code",[t._v("新建项目")])]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/7986413-d97bf80a83e45895c.webp",alt:""}})]),t._v(" "),a("p",[t._v("输入项目名称及描述信息，设置可见等级：私有，内部，公开。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622288467482d.jpg",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"初始化项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化项目"}},[t._v("#")]),t._v(" 初始化项目")]),t._v(" "),a("p",[t._v("我们可以选择通过增加一个README的方式来初始化项目,如下:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622288978567e.jpg",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/7986413-38bb77b9e693be70f.png",alt:""}})]),t._v(" "),a("p",[t._v("创建项目的时候有一个问题，在自己最开始定义了端口号，创建项目的时候会没有端口号，这时候clone项目的时候会访问不了，这时候我们在最开始安装定义目录里面config目录下找到"),a("code",[t._v("gitlab.rb")]),t._v(",编辑它，搜索"),a("code",[t._v("external_url")]),t._v("，没有就添加"),a("code",[t._v("external_url:主机ip+端口号")]),t._v("，有就修改就行了。这时候我们就可以去克隆项目了。当然我们也可以通过下面方法去把项目推送到gitlab上面:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622298003116g.jpg",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622289009680h.jpg",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"gitlab-runner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner"}},[t._v("#")]),t._v(" Gitlab-Runner")]),t._v(" "),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("sudo docker run "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("restart always \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock \\\n  gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n")])])]),a("p",[t._v("映射"),a("code",[t._v("/var/run/docker.sock")]),t._v("这个文件是为了让容器可以通过"),a("code",[t._v("/var/run/docker.sock")]),t._v("与"),a("code",[t._v("Docker")]),t._v("守护进程通信，管理其他"),a("code",[t._v("Docker")]),t._v("容器\n"),a("code",[t._v("-v /home/gitlab-runner/config:/etc/gitlab-runner")]),t._v("是将runner的配置文件映射到宿主机"),a("code",[t._v("/home/gitlab-runner/config")]),t._v("方便调整和查看配置")]),t._v(" "),a("p",[t._v("安装完成我们需要去注册Gitlab-Runner。")]),t._v(" "),a("p",[t._v("运行"),a("code",[t._v("docker ps")]),t._v("查看:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("root@iZm5ebvlfc3n55vzckl9ifZ"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab# docker ps\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CONTAINER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ID")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IMAGE")]),t._v("                         "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COMMAND")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CREATED")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("STATUS")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PORTS")]),t._v("                                                                         "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NAMES")]),t._v("\ned6c7a038263        gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest   "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/dumb-init …"')]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" hours ago        Up "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" hours                                                                                          gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner\nddc7d0e214ef        twang2218"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ce"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("zh        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/assets/wrapper"')]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" hours ago        Up "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hours")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8084")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2222")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tcp   gitlab_web_1\n\n")])])]),a("h3",{attrs:{id:"注册"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注册"}},[t._v("#")]),t._v(" 注册")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("docker run "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("rm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("srv"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner register \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("non"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("interactive \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("executor "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("image alpine"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("url "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("registration"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("token "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("description "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"first-register-runner"')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("list "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vue3-app"')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("run"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("untagged"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("locked"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"false"')]),t._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("access"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("level"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not_protected"')]),t._v("\n")])])]),a("p",[t._v("注册需要输出url，token，描述，tag，执行器等，url和token怎么来的呢?在设置->CI/CD->Runner里面，我这里面注册了一个专用的和共享的Runner，正常情况我们用专用Runner就可以了。共享版Runner是登录root账户在头部小扳手图片里面的Runner得到url和token，然后去注册。这里面的tag值会在编写"),a("code",[t._v(".gitlab-ci.yml")]),t._v("时用到。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622298841818i.jpg",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"运行流水线"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运行流水线"}},[t._v("#")]),t._v(" 运行流水线")]),t._v(" "),a("p",[t._v("在项目根目录里面创建一个"),a("code",[t._v(".gitlab-ci.yml")]),t._v("，编写代码如下:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("image"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" node"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("alpine\n\nstages"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 分段\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" install\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" eslint\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" deploy\n\ncache"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 缓存\n  paths"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" node_modules\n\njob_install"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  tags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  stage"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" install\n  script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm install\n\njob_build"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  tags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  stage"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" build\n  script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm run build\n")])])]),a("p",[t._v("参数说明:")]),t._v(" "),a("ul",[a("li",[t._v("stages:pipeline的阶段列表，定义整个pipeline阶段")]),t._v(" "),a("li",[t._v("stage:定义某个job的所在阶段")]),t._v(" "),a("li",[t._v("image:指定一个基础Docker进行作为基础运行环境，比如:node,python,java")]),t._v(" "),a("li",[t._v("tags:用于指定Runner，tags的取值范围是在该项目可惜可见的runner tags中，也就是前面我们设置的那个tag")]),t._v(" "),a("li",[t._v("only/except:知道当前任务条件")]),t._v(" "),a("li",[t._v("when:实现在发生故障时仍能运行的作业")]),t._v(" "),a("li",[t._v("cache:讲当前工作环境目录中的一些文件，文件夹存储起来，用于在各个任务初始化的时候恢复")]),t._v(" "),a("li",[t._v("environment:指定部署相关任务的环境，并非真实环境，是对要部署到某环境的任务的归类。方便在gitlab上聚合以便进行回滚和重新部署操作")]),t._v(" "),a("li",[t._v("artifacts:保留文档。在每次 job 之前runner会清除未被 git 跟踪的文件。为了让编译或其他操作后的产物可以留存到后续使用，添加该参数并设置保留的目录，保留时间等。被保留的文件将被上传到gitlab以备后续使用。")]),t._v(" "),a("li",[t._v("dependencies:任务依赖。指定job的前置job。添加该参数后，可以获取到前置job的artifacts。注意如果前置 job 执行失败，导致没能生成artifacts，则 job 也会直接失败。")])]),t._v(" "),a("p",[t._v("编写好上面代码后推送到gitlab后就会自己执行里面的语句:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622299460821j.jpg",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),a("p",[t._v("在项目中创建一个"),a("code",[t._v("Dockerfile")]),t._v("，代码如下:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FROM")]),t._v(" node"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" builder\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("WORKDIR")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("app\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("json\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RUN")]),t._v(" npm install "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("registry"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("registry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("npm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("taobao"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("org\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RUN")]),t._v(" npm run build\n\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FROM")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COPY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("builder "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("dist "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("share"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("html\n")])])]),a("p",[a("code",[t._v(".gitlab-ci.yml")]),t._v("修改如下:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("image"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" node"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("alpine\n\nstages"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 分段\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" install\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" eslint\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" deploy\n\ncache"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" # 缓存\n  paths"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" node_modules\n\njob_install"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  tags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  stage"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" install\n  script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm install\n\njob_build"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  tags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" vue3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app\n  stage"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" build\n  script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" npm run build\n\njob_deploy"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    image"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" docker\n    stage"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" deploy\n    script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" docker build "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t appimages\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("docker ps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("aq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("filter name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" then docker rm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f app"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("fi\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" docker run "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8082")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name app"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("container appimages\n")])])]),a("p",[t._v("if语句判断:使用docker命令去搜索docker容器里面是否有一个name为"),a("code",[t._v("app-container")]),t._v("的容器，如果有就销毁掉,销毁掉是为了使用新的容器重新运行。")]),t._v(" "),a("p",[t._v("这里"),a("code",[t._v("image:docker")]),t._v("不写的话会报错:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622301667720k.jpg",alt:""}})]),t._v(" "),a("p",[t._v("代码推送后，流水线工作，到第三步就会出下报错:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622301866992l.jpg",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622301814039m.jpg",alt:""}})]),t._v(" "),a("p",[t._v("解决办法,在runner配置文件中配置docker命令:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/docker:/usr/bin/docker"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/docker.sock:/var/run/docker.sock"')]),t._v("\n")])])]),a("p",[t._v("在gitlab-runner->config-vim config.toml，找到注册runner所对应的token，在volumes数组里面加入上面命令:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("concurrent "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\ncheck_interval "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("session_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  session_timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1800")]),t._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"first-register-runner"')]),t._v("\n  url "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  token "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  executor "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("custom_build_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gcs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("azure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    tls_verify "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    image "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alpine:latest"')]),t._v("\n    privileged "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    disable_entrypoint_overwrite "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    oom_kill_disable "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    disable_cache "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    volumes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cache"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/docker:/usr/bin/docker"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/docker.sock:/var/run/docker.sock"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    shm_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),a("p",[t._v("我们在去重新运行失败的Jobs，这时候发现成功了:")]),t._v(" "),a("p",[a("img",{attrs:{src:"/modular/1622302501014n.jpg",alt:""}})]),t._v(" "),a("p",[t._v("然后通过前面注册的端口号去访问，可以正常访问项目。")])])}),[],!1,null,null,null);s.default=e.exports}}]);